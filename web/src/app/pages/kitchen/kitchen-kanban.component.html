<p-toast></p-toast>

<div class="flex justify-content-between align-items-center mb-3">
  <p-breadcrumb [model]="items" [home]="home"></p-breadcrumb>

  <button
    pButton
    icon="pi pi-refresh"
    label="Atualizar"
    [loading]="loading"
    (click)="loadOrders()"
    class="p-button-sm p-button-outlined">
  </button>
</div>

<div class="kanban-container" cdkDropListGroup>

  <p-card header="PENDENTE" class="kanban-column" id="pendingList">
    <ng-template pTemplate="header">
      <div class="flex justify-content-between align-items-center p-3">
        <span class="font-bold text-lg">PENDENTE</span>
        <p-tag [value]="pending.length.toString()" severity="warn"></p-tag>
      </div>
    </ng-template>

    <div
      cdkDropList
      [cdkDropListData]="pending"
      class="kanban-list"
      [cdkDropListConnectedTo]="[]"
      (cdkDropListDropped)="drop($event)">

      @if (loading) {
        <p-skeleton height="120px" styleClass="mb-2"></p-skeleton>
        <p-skeleton height="120px" styleClass="mb-2"></p-skeleton>
        <p-skeleton height="120px"></p-skeleton>
      } @else {
        @for (order of pending; track order.id) {
          <div cdkDrag class="kanban-card">
            <div class="flex justify-content-between align-items-center mb-2">
              <span class="text-2xl font-bold">#{{ order.number }}</span>
              <p-tag severity="warn" value="Pendente"></p-tag>
            </div>

            <div class="mb-2">
              <div class="text-sm text-600 mb-1">
                <i class="pi pi-ticket mr-1"></i>
                <strong>Comanda:</strong> {{ order.ticket?.number || 'N/A' }}
              </div>

              @if (order.ticket?.name) {
                <div class="text-sm text-600 mb-1">
                  <i class="pi pi-user mr-1"></i>
                  <strong>Cliente:</strong> {{ order.ticket.name }}
                </div>
              }

              <div class="text-sm text-600">
                <i class="pi pi-clock mr-1"></i>
                <strong>Há:</strong> {{ getTimeSince(order.createdAt) }}
              </div>
            </div>

            @if (order.observation) {
              <div class="mb-2 p-2" style="background: #fef3c7; border-radius: 6px; border-left: 3px solid #f59e0b;">
                <div class="text-xs font-semibold text-700 mb-1">
                  <i class="pi pi-info-circle mr-1"></i> Observação:
                </div>
                <div class="text-xs text-600">{{ order.observation }}</div>
              </div>
            }

            @if (order.items && order.items.length > 0) {
              <div class="mt-2 pt-2" style="border-top: 1px solid #e5e7eb;">
                <div class="flex justify-content-between align-items-center mb-2">
                  <span class="text-xs font-semibold text-700">
                    <i class="pi pi-list mr-1"></i> Itens ({{ getTotalItems(order) }})
                  </span>
                  @if (order.totalValue) {
                    <span class="text-xs font-bold text-900">
                      {{ order.totalValue | currency:'BRL' }}
                    </span>
                  }
                </div>

                @for (item of order.items; track item.id) {
                  <div class="mb-2 p-2" style="background: #f9fafb; border-radius: 4px;">
                    <div class="flex justify-content-between align-items-start">
                      <div class="text-sm font-medium text-900">
                        <span class="font-bold text-primary">{{ item.quantity }}x</span>
                        {{ item.product.name }}
                      </div>
                      @if (item.totalPrice) {
                        <span class="text-xs text-600">{{ item.totalPrice | currency:'BRL' }}</span>
                      }
                    </div>

                    @if (item.observation) {
                      <div class="text-xs text-600 mt-1 ml-3">
                        <i class="pi pi-comment mr-1" style="font-size: 0.7rem;"></i>
                        {{ item.observation }}
                      </div>
                    }
                  </div>
                }
              </div>
            }
          </div>
        }

        @if (!loading && pending.length === 0) {
          <div class="text-center text-500 mt-3 p-3">
            <i class="pi pi-check-circle text-4xl mb-2"></i>
            <div>Nenhum pedido pendente</div>
          </div>
        }
      }
    </div>
  </p-card>

  <p-card header="EM ANDAMENTO" class="kanban-column" id="inProgressList">
    <ng-template pTemplate="header">
      <div class="flex justify-content-between align-items-center p-3">
        <span class="font-bold text-lg">EM ANDAMENTO</span>
        <p-tag [value]="inProgress.length.toString()" severity="info"></p-tag>
      </div>
    </ng-template>

    <div
      cdkDropList
      [cdkDropListData]="inProgress"
      class="kanban-list"
      [cdkDropListConnectedTo]="[]"
      (cdkDropListDropped)="drop($event)">

      @if (loading) {
        <p-skeleton height="120px" styleClass="mb-2"></p-skeleton>
        <p-skeleton height="120px" styleClass="mb-2"></p-skeleton>
      } @else {
        @for (order of inProgress; track order.id) {
          <div cdkDrag class="kanban-card in-progress">
            <div class="flex justify-content-between align-items-center mb-2">
              <span class="text-2xl font-bold">#{{ order.number }}</span>
              <p-tag severity="info" value="Em Andamento"></p-tag>
            </div>

            <div class="mb-2">
              <div class="text-sm text-600 mb-1">
                <i class="pi pi-ticket mr-1"></i>
                <strong>Comanda:</strong> {{ order.ticket?.number || 'N/A' }}
              </div>

              @if (order.ticket?.name) {
                <div class="text-sm text-600 mb-1">
                  <i class="pi pi-user mr-1"></i>
                  <strong>Cliente:</strong> {{ order.ticket.name }}
                </div>
              }

              <div class="text-sm text-600">
                <i class="pi pi-clock mr-1"></i>
                <strong>Há:</strong> {{ getTimeSince(order.createdAt) }}
              </div>
            </div>

            @if (order.observation) {
              <div class="mb-2 p-2" style="background: #dbeafe; border-radius: 6px; border-left: 3px solid #3b82f6;">
                <div class="text-xs font-semibold text-700 mb-1">
                  <i class="pi pi-info-circle mr-1"></i> Observação:
                </div>
                <div class="text-xs text-600">{{ order.observation }}</div>
              </div>
            }

            @if (order.items && order.items.length > 0) {
              <div class="mt-2 pt-2" style="border-top: 1px solid #e5e7eb;">
                <div class="flex justify-content-between align-items-center mb-2">
                  <span class="text-xs font-semibold text-700">
                    <i class="pi pi-list mr-1"></i> Itens ({{ getTotalItems(order) }})
                  </span>
                  @if (order.totalValue) {
                    <span class="text-xs font-bold text-900">
                      {{ order.totalValue | currency:'BRL' }}
                    </span>
                  }
                </div>

                @for (item of order.items; track item.id) {
                  <div class="mb-2 p-2" style="background: #f9fafb; border-radius: 4px;">
                    <div class="flex justify-content-between align-items-start">
                      <div class="text-sm font-medium text-900">
                        <span class="font-bold text-primary">{{ item.quantity }}x</span>
                        {{ item.product.name }}
                      </div>
                      @if (item.totalPrice) {
                        <span class="text-xs text-600">{{ item.totalPrice | currency:'BRL' }}</span>
                      }
                    </div>

                    @if (item.observation) {
                      <div class="text-xs text-600 mt-1 ml-3">
                        <i class="pi pi-comment mr-1" style="font-size: 0.7rem;"></i>
                        {{ item.observation }}
                      </div>
                    }
                  </div>
                }
              </div>
            }
          </div>
        }

        @if (!loading && inProgress.length === 0) {
          <div class="text-center text-500 mt-3 p-3">
            <i class="pi pi-inbox text-4xl mb-2"></i>
            <div>Nenhum pedido em produção</div>
          </div>
        }
      }
    </div>
  </p-card>

  <p-card header="PRONTO" class="kanban-column" id="readyList">
    <ng-template pTemplate="header">
      <div class="flex justify-content-between align-items-center p-3">
        <span class="font-bold text-lg">PRONTO</span>
        <p-tag [value]="ready.length.toString()" severity="success"></p-tag>
      </div>
    </ng-template>

    <div
      cdkDropList
      [cdkDropListData]="ready"
      class="kanban-list"
      [cdkDropListConnectedTo]="[]"
      (cdkDropListDropped)="drop($event)">

      @if (loading) {
        <p-skeleton height="120px" styleClass="mb-2"></p-skeleton>
        <p-skeleton height="120px"></p-skeleton>
      } @else {
        @for (order of ready; track order.id) {
          <div cdkDrag class="kanban-card ready">
            <div class="flex justify-content-between align-items-center mb-2">
              <span class="text-2xl font-bold">#{{ order.number }}</span>
              <p-tag severity="success" value="Pronto"></p-tag>
            </div>

            <div class="mb-2">
              <div class="text-sm text-600 mb-1">
                <i class="pi pi-ticket mr-1"></i>
                <strong>Comanda:</strong> {{ order.ticket?.number || 'N/A' }}
              </div>

              @if (order.ticket?.name) {
                <div class="text-sm text-600 mb-1">
                  <i class="pi pi-user mr-1"></i>
                  <strong>Cliente:</strong> {{ order.ticket.name }}
                </div>
              }

              <div class="text-sm text-600">
                <i class="pi pi-clock mr-1"></i>
                <strong>Há:</strong> {{ getTimeSince(order.createdAt) }}
              </div>
            </div>

            @if (order.observation) {
              <div class="mb-2 p-2" style="background: #d1fae5; border-radius: 6px; border-left: 3px solid #10b981;">
                <div class="text-xs font-semibold text-700 mb-1">
                  <i class="pi pi-info-circle mr-1"></i> Observação:
                </div>
                <div class="text-xs text-600">{{ order.observation }}</div>
              </div>
            }

            @if (order.items && order.items.length > 0) {
              <div class="mt-2 pt-2" style="border-top: 1px solid #e5e7eb;">
                <div class="flex justify-content-between align-items-center mb-2">
                  <span class="text-xs font-semibold text-700">
                    <i class="pi pi-list mr-1"></i> Itens ({{ getTotalItems(order) }})
                  </span>
                  @if (order.totalValue) {
                    <span class="text-xs font-bold text-900">
                      {{ order.totalValue | currency:'BRL' }}
                    </span>
                  }
                </div>

                @for (item of order.items; track item.id) {
                  <div class="mb-2 p-2" style="background: #f9fafb; border-radius: 4px;">
                    <div class="flex justify-content-between align-items-start">
                      <div class="text-sm font-medium text-900">
                        <span class="font-bold text-primary">{{ item.quantity }}x</span>
                        {{ item.product.name }}
                      </div>
                      @if (item.totalPrice) {
                        <span class="text-xs text-600">{{ item.totalPrice | currency:'BRL' }}</span>
                      }
                    </div>

                    @if (item.observation) {
                      <div class="text-xs text-600 mt-1 ml-3">
                        <i class="pi pi-comment mr-1" style="font-size: 0.7rem;"></i>
                        {{ item.observation }}
                      </div>
                    }
                  </div>
                }
              </div>
            }
          </div>
        }

        @if (!loading && ready.length === 0) {
          <div class="text-center text-500 mt-3 p-3">
            <i class="pi pi-inbox text-4xl mb-2"></i>
            <div>Nenhum pedido pronto</div>
          </div>
        }
      }
    </div>
  </p-card>
</div>
